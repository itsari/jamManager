<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>jamManager - <%= song.name %></title>
    <link rel="stylesheet" href="/css/style.css" />
    <style>
      .chord-tooltip {
        display: none;
        position: absolute;
        background-color: white;
        border: 1px solid #ccc;
        padding: 5px;
        z-index: 10;
      }
      .font-size-control,
      .scroll-controls,
      .transpose-controls {
        margin: 10px 0;
      }
      .lyrics,
      .chords {
        font-size: 16px; /* Default font size */
      }
      .scroll-container {
        height: 400px; /* Set a height to make the div scrollable */
        overflow-y: auto; /* Enable vertical scrolling */
        border: 1px solid #ccc;
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <%- include('header') %>
    <h2><%= song.name %> by <%= song.artist %></h2>
    <p><strong>Album:</strong> <%= song.album %></p>
    <p><strong>Tempo:</strong> <%= song.tempo %></p>

    <div class="font-size-control">
      <label for="font-size-range">Font Size:</label>
      <input type="range" id="font-size-range" min="10" max="30" value="16" />
    </div>

    <div class="scroll-controls">
      <button onclick="startScroll(1)">X1</button>
      <button onclick="startScroll(2)">X2</button>
      <button onclick="startScroll(3)">X3</button>
      <button onclick="startScroll(4)">X4</button>
      <button onclick="startScroll(5)">X5</button>
      <button onclick="stopScroll()">Stop</button>
    </div>

    <div class="transpose-controls">
      <button onclick="transposeChords(1)">+</button>
      <button onclick="transposeChords(-1)">-</button>
    </div>

    <h3>Lyrics and Chords</h3>
    <div class="scroll-container" id="scroll-container">
      <% parsedLyrics.forEach(line => { %>
      <div>
        <div class="chords">
          <% line.chords.forEach(chord => { %>
          <span class="chord" data-chord="<%= chord %>"><%= chord %></span>
          <% }) %>
        </div>
        <div class="lyrics">
          <pre><%= line.lyrics %></pre>
        </div>
      </div>
      <% }) %>
    </div>
    <div class="youtube-play">
      <iframe
        width="560"
        height="315"
        src="https://www.youtube.com/embed/<%= song.youtube_link %>"
        title="YouTube video player"
        frameborder="0"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
        allowfullscreen
      ></iframe>
    </div>
    <%- include('footer') %>
    <script src="https://cdn.jsdelivr.net/npm/@tonaljs/tonal@4.10.0/dist/index.min.js"></script>
    <script>
      document
        .getElementById("font-size-range")
        .addEventListener("input", function () {
          var newSize = this.value + "px";
          document
            .querySelectorAll(".lyrics, .chords")
            .forEach(function (element) {
              element.style.fontSize = newSize;
            });
        });

      let scrollInterval;

      function startScroll(speed) {
        stopScroll(); // Stop any existing scrolling

        const speedMapping = {
          1: 100,
          2: 80,
          3: 60,
          4: 40,
          5: 20,
        };

        const scrollSpeed = speedMapping[speed];
        const scrollContainer = document.getElementById("scroll-container");
        scrollInterval = setInterval(() => {
          scrollContainer.scrollBy(0, 1);
        }, scrollSpeed);
      }

      function stopScroll() {
        clearInterval(scrollInterval);
      }

      function transposeChords(semitones) {
        // Check if tonal is loaded correctly
        if (typeof tonal === "undefined") {
          console.error("Tonal library not loaded");
          return;
        }

        document.querySelectorAll(".chord").forEach(function (element) {
          let originalChord = element.getAttribute("data-chord");
          try {
            let transposedChord = tonal.transpose(
              originalChord,
              tonal.Interval.fromSemitones(semitones)
            );
            element.innerText = transposedChord;
            element.setAttribute("data-chord", transposedChord);
          } catch (error) {
            console.error("Error transposing chord:", originalChord, error);
          }
        });
      }
    </script>
  </body>
</html>
